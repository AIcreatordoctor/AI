<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Task Manager Pro ‚Äî –õ–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {font-family: 'Segoe UI', Arial, sans-serif; background: #f7f9fb; margin:0; padding:0;}
    .container {max-width: 1250px; margin: 0 auto; padding: 24px;}
    h1 {font-size: 2.2em; color:#236372;}
    .controls {display:flex; gap:14px; flex-wrap:wrap; margin-bottom:18px;}
    .controls input, .controls select {padding:6px 12px; font-size:1em;}
    .add-btn, .import-btn, .export-btn {padding:7px 20px; border:none; border-radius:5px; font-weight:600; background:#236372; color:#fff; cursor:pointer;}
    .add-btn:hover, .import-btn:hover, .export-btn:hover {background:#267ca8;}
    table {width:100%; border-collapse:collapse; background:#fff; border-radius:10px; box-shadow:0 2px 12px #0001;}
    th, td {padding:7px 9px; border-bottom:1px solid #f1f1f1; font-size:1em;}
    th {background:#e7f2f7; color:#236372;}
    tr:last-child td {border-bottom:none;}
    tr:hover:not(.dashboard-row) {background:#f8fcfd;}
    .status-new {color:#267ca8;}
    .status-inprogress {color:#d4981b;}
    .status-done {color:#26a866;}
    .status-deferred {color:#8b8b8b;}
    .status-cancelled {color:#d43434;}
    .wsjf-high {background:#f9dada;}
    .wsjf-med {background:#fff6db;}
    .wsjf-low {background:#e6f7e6;}
    .deadline-red {background:#ffd4d4 !important;}
    .deadline-yellow {background:#fff7d1 !important;}
    .category-badge {display:inline-block; padding:3px 7px; background:#e3e8f3; border-radius:4px; margin-right:3px;}
    .edit-btn, .del-btn {padding:3px 10px; border:none; border-radius:4px; font-size:0.95em; margin-right:3px; cursor:pointer;}
    .edit-btn {background:#e0f7fa; color:#236372;}
    .del-btn {background:#fbe9e7; color:#d43434;}
    .modal-bg {display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0007; align-items:center; justify-content:center; z-index:1000;}
    .modal {background:#fff; padding:22px 18px 12px 18px; border-radius:9px; max-width:420px; width:95%; box-shadow:0 6px 40px #0003;}
    .modal h2 {margin-top:0;}
    .modal label {display:block; margin-top:12px;}
    .modal input, .modal select, .modal textarea {width:98%; padding:7px; font-size:1em; margin-top:3px;}
    .modal .form-btns {margin-top:18px; display:flex; justify-content:space-between;}
    .close-modal {background:#e7f2f7; color:#236372; border:none; border-radius:5px; padding:7px 14px; cursor:pointer;}
    .save-btn {background:#236372; color:#fff; border:none; border-radius:5px; padding:7px 18px; cursor:pointer;}
    .save-btn:hover {background:#267ca8;}
    .dashboard {margin-top:35px; margin-bottom:12px;}
    .chart-container {display:flex; gap:40px; flex-wrap:wrap;}
    .chart-block {background:#fff; padding:16px 22px 10px 22px; border-radius:11px; box-shadow:0 2px 12px #0001; margin-bottom:25px;}
    .chart-block h3 {margin-top:0; font-size:1.1em;}
    .import-input {display:none;}
    @media (max-width:900px) {.chart-container{flex-direction:column;}}
    @media (max-width:600px){
      .controls {flex-direction:column;}
      .chart-block {padding:10px 2vw;}
      .modal {padding: 8px;}
      .container {padding:7px;}
      table th,table td {font-size:0.9em;}
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Task Manager Pro ‚Äî –õ–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏</h1>
  <div class="controls">
    <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, WSJF...">
    <select id="statusFilter">
      <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
      <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
      <option value="–ì–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
      <option value="–û—Ç–ª–æ–∂–µ–Ω–∞">–û—Ç–ª–æ–∂–µ–Ω–∞</option>
      <option value="–û—Ç–º–µ–Ω–µ–Ω–∞">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
    </select>
    <select id="categoryFilter">
      <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
    </select>
    <button class="add-btn" onclick="openModal()">+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
    <button class="import-btn" onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç</button>
    <input id="importFile" class="import-input" type="file" accept=".json" onchange="importTasks(this)">
    <button class="export-btn" onclick="exportTasks()">–≠–∫—Å–ø–æ—Ä—Ç</button>
  </div>

  <table id="tasksTable">
    <thead>
      <tr>
        <th>–ó–∞–¥–∞—á–∞</th>
        <th>WSJF</th>
        <th>–≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä</th>
        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
        <th>–û—Ç –∫–æ–≥–æ</th>
        <th>–î–∞—Ç–∞</th>
        <th>–î–µ–¥–ª–∞–π–Ω</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="dashboard">
    <div class="chart-container">
      <div class="chart-block"><h3>–ó–∞–¥–∞—á–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É</h3><canvas id="statusChart" width="240" height="200"></canvas></div>
      <div class="chart-block"><h3>–ó–∞–¥–∞—á–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3><canvas id="categoryChart" width="240" height="200"></canvas></div>
      <div class="chart-block"><h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ WSJF</h3><canvas id="wsjfChart" width="240" height="200"></canvas></div>
    </div>
  </div>
</div>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2 id="modalTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
    <form id="taskForm" onsubmit="saveTask(event)">
      <input type="hidden" id="editIndex">
      <label>–ó–∞–¥–∞—á–∞<input id="taskName" required></label>
      <label>WSJF
        <select id="taskWSJF" required>
          <option value="">‚Äî</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="5">5</option>
          <option value="8">8</option>
          <option value="13">13</option>
          <option value="21">21</option>
        </select>
      </label>
      <label>–≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä
        <select id="taskEisen">
          <option value="">‚Äî</option>
          <option value="–°—Ä–æ—á–Ω–æ –∏ –≤–∞–∂–Ω–æ (–î–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å)">–°—Ä–æ—á–Ω–æ –∏ –≤–∞–∂–Ω–æ (–î–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å)</option>
          <option value="–í–∞–∂–Ω–æ, –Ω–æ –Ω–µ —Å—Ä–æ—á–Ω–æ (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å)">–í–∞–∂–Ω–æ, –Ω–æ –Ω–µ —Å—Ä–æ—á–Ω–æ (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å)</option>
          <option value="–°—Ä–æ—á–Ω–æ, –Ω–æ –Ω–µ –≤–∞–∂–Ω–æ (–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å)">–°—Ä–æ—á–Ω–æ, –Ω–æ –Ω–µ –≤–∞–∂–Ω–æ (–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å)</option>
          <option value="–ù–µ –≤–∞–∂–Ω–æ –∏ –Ω–µ —Å—Ä–æ—á–Ω–æ (–£–¥–∞–ª–∏—Ç—å / –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)">–ù–µ –≤–∞–∂–Ω–æ –∏ –Ω–µ —Å—Ä–æ—á–Ω–æ (–£–¥–∞–ª–∏—Ç—å / –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)</option>
        </select>
      </label>
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è
        <select id="taskCategory" required>
          <option value="">‚Äî</option>
          <option value="–ü—Ä–æ–¥—É–∫—Ç">–ü—Ä–æ–¥—É–∫—Ç</option>
          <option value="–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</option>
          <option value="–ò–ò">–ò–ò</option>
          <option value="–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞</option>
          <option value="–í—Å—Ç—Ä–µ—á–∏">–í—Å—Ç—Ä–µ—á–∏</option>
          <option value="–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ">–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</option>
          <option value="–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</option>
        </select>
      </label>
      <label>–û—Ç –∫–æ–≥–æ<input id="taskAuthor"></label>
      <label>–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è<input id="taskDate" type="date"></label>
      <label>–î–µ–¥–ª–∞–π–Ω<input id="taskDeadline" type="date"></label>
      <label>–°—Ç–∞—Ç—É—Å
        <select id="taskStatus">
          <option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
          <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
          <option value="–ì–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
          <option value="–û—Ç–ª–æ–∂–µ–Ω–∞">–û—Ç–ª–æ–∂–µ–Ω–∞</option>
          <option value="–û—Ç–º–µ–Ω–µ–Ω–∞">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
        </select>
      </label>
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π<textarea id="taskComment"></textarea></label>
      <label>–†–µ–∑—É–ª—å—Ç–∞—Ç<textarea id="taskResult"></textarea></label>
      <div class="form-btns">
        <button class="save-btn" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="close-modal" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- Data logic ---
  let tasks = JSON.parse(localStorage.getItem('tasksPro')) || [];

  function saveTasks() { localStorage.setItem('tasksPro', JSON.stringify(tasks)); }

  // --- Render Logic ---
  function renderTable() {
    const tbody = document.querySelector('#tasksTable tbody');
    tbody.innerHTML = '';
    let search = document.getElementById('search').value.trim().toLowerCase();
    let statusF = document.getElementById('statusFilter').value;
    let catF = document.getElementById('categoryFilter').value;

    // –°–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    let categories = new Set();
    tasks.forEach(t => { if (t.category) categories.add(t.category); });
    let catSel = document.getElementById('categoryFilter');
    let selected = catSel.value;
    catSel.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
    Array.from(categories).sort().forEach(c=>{
      let opt = document.createElement('option');
      opt.value = c; opt.innerText = c;
      if (selected===c) opt.selected=true;
      catSel.appendChild(opt);
    });

    tasks.forEach((task, idx) => {
      if (
        (search && ![task.name, task.category, task.wsjf, task.eisen, task.comment, task.author, task.result].some(v => (v||'').toString().toLowerCase().includes(search)))
        || (statusF && task.status !== statusF)
        || (catF && task.category !== catF)
      ) return;

      let tr = document.createElement('tr');

      // --- –î–µ–¥–ª–∞–π–Ω —Ä–∞—Å–∫—Ä–∞—Å–∫–∞
      let deadlineClass = '';
      if (task.deadline) {
        let d = new Date(task.deadline), today = new Date();
        today.setHours(0,0,0,0);
        if ((d - today) < 0) deadlineClass = 'deadline-red';
        else if ((d - today) <= 3*24*3600*1000) deadlineClass = 'deadline-yellow';
      }

      // --- WSJF —Ü–≤–µ—Ç
      let wsjfClass = '';
      if (+task.wsjf >= 13) wsjfClass = 'wsjf-high';
      else if (+task.wsjf >= 5) wsjfClass = 'wsjf-med';
      else wsjfClass = 'wsjf-low';

      // --- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –±–∞–¥–∂
      let catBadge = task.category ? `<span class="category-badge">${task.category}</span>` : '';

      tr.innerHTML = `
        <td>${task.name||''}</td>
        <td class="${wsjfClass}" style="text-align:center">${task.wsjf||''}</td>
        <td>${task.eisen||''}</td>
        <td>${catBadge}</td>
        <td>${task.author||''}</td>
        <td>${task.date||''}</td>
        <td class="${deadlineClass}" style="text-align:center">${task.deadline||''}</td>
        <td class="status-${statusColor(task.status)}">${task.status||''}</td>
        <td>${task.comment||''}</td>
        <td>${task.result||''}</td>
        <td>
          <button class="edit-btn" onclick="openModal(${idx})">‚úèÔ∏è</button>
          <button class="del-btn" onclick="delTask(${idx})">üóëÔ∏è</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    drawDashboards();
  }

  function statusColor(st) {
    if (!st) return '';
    if (st=="–í —Ä–∞–±–æ—Ç–µ") return "inprogress";
    if (st=="–ì–æ—Ç–æ–≤–æ") return "done";
    if (st=="–û—Ç–ª–æ–∂–µ–Ω–∞") return "deferred";
    if (st=="–û—Ç–º–µ–Ω–µ–Ω–∞") return "cancelled";
    if (st=="–ù–æ–≤–∞—è") return "new";
    return '';
  }

  // --- Modal Logic ---
  function openModal(idx) {
    document.getElementById('modalBg').style.display = 'flex';
    document.getElementById('taskForm').reset();
    document.getElementById('editIndex').value = idx === undefined ? '' : idx;
    document.getElementById('modalTitle').innerText = idx === undefined ? "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É";
    if (idx !== undefined) {
      let t = tasks[idx];
      document.getElementById('taskName').value = t.name||'';
      document.getElementById('taskWSJF').value = t.wsjf||'';
      document.getElementById('taskEisen').value = t.eisen||'';
      document.getElementById('taskCategory').value = t.category||'';
      document.getElementById('taskAuthor').value = t.author||'';
      document.getElementById('taskDate').value = t.date||'';
      document.getElementById('taskDeadline').value = t.deadline||'';
      document.getElementById('taskStatus').value = t.status||'–ù–æ–≤–∞—è';
      document.getElementById('taskComment').value = t.comment||'';
      document.getElementById('taskResult').value = t.result||'';
    }
  }
  function closeModal() { document.getElementById('modalBg').style.display = 'none'; }

  function saveTask(ev) {
    ev.preventDefault();
    let t = {
      name: document.getElementById('taskName').value,
      wsjf: document.getElementById('taskWSJF').value,
      eisen: document.getElementById('taskEisen').value,
      category: document.getElementById('taskCategory').value,
      author: document.getElementById('taskAuthor').value,
      date: document.getElementById('taskDate').value,
      deadline: document.getElementById('taskDeadline').value,
      status: document.getElementById('taskStatus').value,
      comment: document.getElementById('taskComment').value,
      result: document.getElementById('taskResult').value,
    };
    let idx = document.getElementById('editIndex').value;
    if (idx === '') tasks.unshift(t);
    else tasks[idx] = t;
    saveTasks();
    closeModal();
    renderTable();
  }
  function delTask(idx) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")) {
      tasks.splice(idx, 1);
      saveTasks();
      renderTable();
    }
  }

  // --- Import/Export ---
  function exportTasks() {
    let data = JSON.stringify(tasks, null, 2);
    let blob = new Blob([data], {type:'application/json'});
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url; a.download = 'tasks.json'; a.click();
    URL.revokeObjectURL(url);
  }
  function importTasks(input) {
    if (!input.files.length) return;
    let file = input.files[0];
    let reader = new FileReader();
    reader.onload = function(e){
      try {
        let arr = JSON.parse(e.target.result);
        if (Array.isArray(arr)) {
          if (confirm('–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ?')) {
            tasks = arr;
            saveTasks();
            renderTable();
          }
        }
      } catch { alert('–§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞'); }
    };
    reader.readAsText(file);
  }

  // --- Chart.js Dashboards ---
  let statusChart, categoryChart, wsjfChart;
  function drawDashboards() {
    // 1. –°—Ç–∞—Ç—É—Å—ã
    let sLabels = ["–ù–æ–≤–∞—è","–í —Ä–∞–±–æ—Ç–µ","–ì–æ—Ç–æ–≤–æ","–û—Ç–ª–æ–∂–µ–Ω–∞","–û—Ç–º–µ–Ω–µ–Ω–∞"];
    let sCounts = sLabels.map(st=>tasks.filter(t=>t.status===st).length);
    // 2. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    let allCats = [...new Set(tasks.map(t=>t.category).filter(Boolean))];
    let cCounts = allCats.map(c=>tasks.filter(t=>t.category===c).length);
    // 3. WSJF buckets
    let wLabels = ["<5","5-10","11-20",">20"];
    let wCounts = [0,0,0,0];
    tasks.forEach(t=>{
      let w = +t.wsjf||0;
      if (w<5) wCounts[0]++;
      else if (w<=10) wCounts[1]++;
      else if (w<=20) wCounts[2]++;
      else wCounts[3]++;
    });
    // Draw
    if (statusChart) statusChart.destroy();
    if (categoryChart) categoryChart.destroy();
    if (wsjfChart) wsjfChart.destroy();
    let ctx1 = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(ctx1, {
      type:'pie',
      data:{labels:sLabels, datasets:[{data:sCounts,backgroundColor:["#90caf9","#ffd54f","#c8e6c9","#e0e0e0","#ffcdd2"]}]},
      options:{responsive:true, plugins:{legend:{position:'bottom'}}}
    });
    let ctx2 = document.getElementById('categoryChart').getContext('2d');
    categoryChart = new Chart(ctx2, {
      type:'bar',
      data:{labels:allCats, datasets:[{data:cCounts,backgroundColor:"#b3e5fc"}]},
      options:{responsive:true, plugins:{legend:{display:false}}}
    });
    let ctx3 = document.getElementById('wsjfChart').getContext('2d');
    wsjfChart = new Chart(ctx3, {
      type:'bar',
      data:{labels:wLabels, datasets:[{data:wCounts,backgroundColor:"#ffe082"}]},
      options:{responsive:true, plugins:{legend:{display:false}}}
    });
  }

  // --- Initial render ---
  document.getElementById('search').oninput = renderTable;
  document.getElementById('statusFilter').onchange = renderTable;
  document.getElementById('categoryFilter').onchange = renderTable;
  renderTable();
</script>
</body>
</html>